<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>带队列限制的 Axios</title>
</head>
<body>
    <button onclick="sendRequest()">发送请求</button>
    <button onclick="sendManyRequests()">发送多个请求（测试队列）</button>

    <script>
        // ========== Cancel 相关 ==========
        class Cancel {
            constructor(message) {
                this.message = message;
            }
        }

        class CancelToken {
            constructor(executor) {
                let resolveCancel;
                this.promise = new Promise(resolve => {
                    resolveCancel = resolve;
                });
                executor(() => {
                    resolveCancel(new Cancel('请求已取消'));
                });
            }
        }

        // ========== Axios 核心 ==========
        class Axios {
            constructor(config) {
                this.config = { ...config };
                this.maxConcurrent = 2;        // ⭐ 最大并发数
                this.runningCount = 0;         // 当前运行请求数
                this.queue = [];               // 等待队列

                // 拦截器
                this.inter = {
                    request: { handler: [], use(fn) { this.handler.push(fn); } },
                    response: { handler: [], use(fn) { this.handler.push(fn); } }
                };
            }

            // ⭐ 执行队列中的下一个请求
            dequeue() {
                if (this.queue.length > 0 && this.runningCount < this.maxConcurrent) {
                    const next = this.queue.shift();
                    this._executeRequest(next.config, next.resolve, next.reject);
                }
            }

            // ⭐ 真正发送 XHR 的内部方法
            _executeRequest(finalconfig, resolve, reject) {
                this.runningCount++; // 增加运行计数

                const xhr = new XMLHttpRequest();
                const fullUrl = finalconfig.baseurl 
                    ? `${finalconfig.baseurl}${finalconfig.url}` 
                    : finalconfig.url;

                xhr.open(finalconfig.method || 'GET', fullUrl);

                // 超时
                if (finalconfig.timeout) {
                    xhr.timeout = finalconfig.timeout;
                    xhr.ontimeout = () => {
                        this.runningCount--;
                        this.dequeue();
                        reject(new Error(`Timeout of ${finalconfig.timeout}ms exceeded`));
                    };
                }

                // 取消监听
                if (finalconfig.cancelToken) {
                    finalconfig.cancelToken.promise.then((cancel) => {
                        xhr.abort();
                        this.runningCount--;
                        this.dequeue();
                        reject(cancel);
                    });
                }

                xhr.onload = () => {
                    this.runningCount--;
                    this.dequeue(); // 启动下一个

                    try {
                        const response = {
                            config: finalconfig, // 用于拦截器
                            data: xhr.responseText ? JSON.parse(xhr.responseText) : {},
                            status: xhr.status,
                            statusText: xhr.statusText
                        };
                        if (response.status >= 200 && response.status < 300) {
                            resolve(response);
                        } else {
                            reject(new Error(`Request failed with status ${response.status}`));
                        }
                    } catch (err) {
                        reject(new Error(`Parse failed: ${err.message}`));
                    }
                };

                xhr.onerror = () => {
                    this.runningCount--;
                    this.dequeue();
                    reject(new Error('Network error'));
                };

                // 发送数据（支持 FormData）
                if (['POST', 'PUT', 'PATCH'].includes(finalconfig.method?.toUpperCase())) {
                    if (finalconfig.data instanceof FormData) {
                        // ✅ 不设置 Content-Type！
                        xhr.send(finalconfig.data);
                    } else {
                        xhr.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
                        xhr.send(JSON.stringify(finalconfig.data || {}));
                    }
                } else {
                    xhr.send();
                }
            }

            request(config) {
                let finalconfig = { ...this.config, ...config };

                // 请求拦截器
                let promiseChain = Promise.resolve(finalconfig);
                this.inter.request.handler.forEach(fn => {
                    promiseChain = promiseChain.then(fn);
                });

                return promiseChain.then(finalconfig => {
                    return new Promise((resolve, reject) => {
                        // ⭐ 判断是否立即执行 or 入队
                        if (this.runningCount < this.maxConcurrent) {
                            this._executeRequest(finalconfig, resolve, reject);
                        } else {
                            this.queue.push({ config: finalconfig, resolve, reject });
                        }
                    });
                }).then(response => {
                    // 响应拦截器（成功）
                    let res = response;
                    this.inter.response.handler.forEach(fn => {
                        res = fn.ful ? fn.ful(res) : res;
                    });
                    return res;
                }, error => {
                    // 响应拦截器（失败）
                    let err = error;
                    this.inter.response.handler.forEach(fn => {
                        err = fn.reject ? fn.reject(err) : err;
                    });
                    return Promise.reject(err);
                });
            }
        }

        // ========== 实例化 ==========
        const myaxios = new Axios({
            baseurl: 'http://121.37.19.240:8080',
            timeout: 5000,
        });

        // ========== 拦截器（可选） ==========
        myaxios.inter.request.use(config => {
            console.log('请求发出:', config.url);
            return config;
        });

        myaxios.inter.response.use(
            res => res,
            err => {
                if (err instanceof Cancel) {
                    console.log('请求被取消:', err.message);
                }
                return Promise.reject(err);
            }
        );

        // ========== 测试函数 ==========
        function sendRequest() {
            myaxios.request({
                method: 'GET',
                url: '/carousel/list'
            }).then(res => {
                console.log('✅ 成功:', res.data);
            }).catch(err => {
                console.log('❌ 失败:', err.message);
            });
        }

        function sendManyRequests() {
            for (let i = 1; i <= 5; i++) {
                setTimeout(() => {
                    myaxios.request({
                        method: 'GET',
                        url: '/carousel/list'
                    }).then(res => {
                        console.log(`✅ 请求 ${i} 成功`);
                    }).catch(err => {
                        console.log(`❌ 请求 ${i} 失败:`, err.message);
                    });
                }, i * 100);
            }
        }
    </script>
</body>
</html>